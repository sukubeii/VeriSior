{% extends 'base/dashboard_base.html' %}
{% load static %}

{% block title %}{{ action }} Team Member - VeriSior{% endblock %}
{% block page_title %}{{ action }} Team Member{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-edit me-2"></i>{{ action }} Team Member
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="teamMemberForm">
                        {% csrf_token %}

                        <div class="row">
                            <!-- Photo Upload Section -->
                            <div class="col-md-4 text-center mb-4">
                                <div class="photo-upload-section">
                                    <div class="current-photo mb-3">
                                        {% if team_member.photo %}
                                            <img src="{{ team_member.photo.url }}"
                                                 alt="{{ team_member.name }}"
                                                 class="current-team-photo rounded-circle"
                                                 id="photoPreview"
                                                 style="width: 150px; height: 150px; object-fit: cover; border: 3px solid #28a745;">
                                        {% else %}
                                            <div class="photo-placeholder rounded-circle mx-auto d-flex align-items-center justify-content-center"
                                                 id="photoPreview"
                                                 style="width: 150px; height: 150px; background-color: #e9ecef; border: 3px dashed #dee2e6;">
                                                <i class="fas fa-user fa-3x text-muted"></i>
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">{{ form.photo.label }}</label>
                                        {{ form.photo }}
                                        <div class="form-text">{{ form.photo.help_text }}</div>
                                        {% if form.photo.errors %}
                                            <div class="text-danger small">
                                                {{ form.photo.errors.0 }}
                                            </div>
                                        {% endif %}
                                    </div>

                                    {% if team_member.photo %}
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="removePhoto" name="remove_photo">
                                        <label class="form-check-label text-danger" for="removePhoto">
                                            <i class="fas fa-trash me-1"></i>Remove current photo
                                        </label>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Form Fields -->
                            <div class="col-md-8">
                                <!-- Name and Role -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-semibold">{{ form.name.label }} <span class="text-danger">*</span></label>
                                            {{ form.name }}
                                            <div class="character-counter" data-target="id_name" data-min="10" data-max="30"></div>
                                            <div class="form-text">10-30 characters (letters only)</div>
                                            {% if form.name.errors %}
                                                <div class="text-danger small">
                                                    {{ form.name.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-semibold">{{ form.role.label }} <span class="text-danger">*</span></label>
                                            {{ form.role }}
                                            <div class="character-counter" data-target="id_role" data-min="10" data-max="20"></div>
                                            <div class="form-text">10-20 characters (letters only)</div>
                                            {% if form.role.errors %}
                                                <div class="text-danger small">
                                                    {{ form.role.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Skills -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="mb-3">
                                            <label class="form-label fw-semibold">{{ form.technical_skills.label }} <span class="text-danger">*</span></label>
                                            {{ form.technical_skills }}
                                            <div class="character-counter" data-target="id_technical_skills" data-min="10" data-max="100"></div>
                                            <div class="form-text">10-100 characters</div>
                                            {% if form.technical_skills.errors %}
                                                <div class="text-danger small">
                                                    {{ form.technical_skills.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="mb-3">
                                            <label class="form-label fw-semibold">{{ form.soft_skills.label }} <span class="text-danger">*</span></label>
                                            {{ form.soft_skills }}
                                            <div class="character-counter" data-target="id_soft_skills" data-min="10" data-max="100"></div>
                                            <div class="form-text">10-100 characters</div>
                                            {% if form.soft_skills.errors %}
                                                <div class="text-danger small">
                                                    {{ form.soft_skills.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Order and Status -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-semibold">{{ form.order.label }}</label>
                                            {{ form.order }}
                                            <div class="form-text">{{ form.order.help_text }}</div>
                                            {% if form.order.errors %}
                                                <div class="text-danger small">
                                                    {{ form.order.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                {{ form.is_active }}
                                                <label class="form-check-label fw-semibold" for="{{ form.is_active.id_for_label }}">
                                                    {{ form.is_active.label }}
                                                </label>
                                            </div>
                                            <div class="form-text">Active team members are displayed on the landing page</div>
                                            {% if form.is_active.errors %}
                                                <div class="text-danger small">
                                                    {{ form.is_active.errors.0 }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="text-center mt-4 pt-4 border-top">
                            <button type="submit" class="btn btn-primary btn-lg me-3">
                                <i class="fas fa-save me-2"></i>Save Changes
                            </button>
                            <a href="{% url 'simple_content_management' %}" class="btn btn-secondary btn-lg me-3">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                            {% if team_member.pk %}
                            <a href="{% url 'delete_team_member' team_member.pk %}"
                               class="btn btn-danger btn-lg"
                               onclick="return confirm('Are you sure you want to delete this team member?')">
                                <i class="fas fa-trash me-2"></i>Delete
                            </a>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
.character-counter {
    font-size: 0.8rem;
    margin-top: 0.25rem;
    text-align: right;
    font-weight: 600;
}

.character-counter.success {
    color: #28a745;
}

.character-counter.warning {
    color: #ffc107;
}

.character-counter.danger {
    color: #dc3545;
}

.photo-upload-section {
    background-color: #f8f9fa;
    border-radius: 12px;
    padding: 2rem 1rem;
}

.current-team-photo {
    transition: transform 0.3s ease;
}

.current-team-photo:hover {
    transform: scale(1.05);
}

.photo-placeholder {
    transition: all 0.3s ease;
}

.photo-placeholder:hover {
    border-color: #28a745;
    background-color: #f0f8f5;
}

#id_photo {
    cursor: pointer;
}

.form-control:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

textarea.form-control {
    resize: vertical;
    min-height: 80px;
}

.form-switch .form-check-input {
    width: 3rem;
    height: 1.5rem;
}

.form-switch .form-check-input:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.form-switch .form-check-input:checked {
    background-color: #28a745;
    border-color: #28a745;
}

.btn-lg {
    padding: 0.75rem 2rem;
    font-size: 1.1rem;
}

.card-header h5 {
    font-weight: 600;
}

.is-invalid {
    border-color: #dc3545 !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Validation rules
    const validationRules = {
        'id_name': { min: 10, max: 30, label: 'Name', type: 'letters' },
        'id_role': { min: 10, max: 20, label: 'Role', type: 'letters' },
        'id_technical_skills': { min: 10, max: 100, label: 'Technical Skills' },
        'id_soft_skills': { min: 10, max: 100, label: 'Soft Skills' }
    };

    // Photo preview functionality
    const photoInput = document.getElementById('id_photo');
    const photoPreview = document.getElementById('photoPreview');
    const removePhotoCheckbox = document.getElementById('removePhoto');

    if (photoInput) {
        photoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Create new image element
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'current-team-photo rounded-circle';
                    img.style.cssText = 'width: 150px; height: 150px; object-fit: cover; border: 3px solid #28a745;';

                    // Replace preview content
                    photoPreview.innerHTML = '';
                    photoPreview.appendChild(img);
                    photoPreview.className = '';

                    // Uncheck remove photo if it was checked
                    if (removePhotoCheckbox) {
                        removePhotoCheckbox.checked = false;
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }

    // Handle remove photo checkbox
    if (removePhotoCheckbox) {
        removePhotoCheckbox.addEventListener('change', function(e) {
            if (e.target.checked) {
                // Show placeholder
                photoPreview.innerHTML = '<i class="fas fa-user fa-3x text-muted"></i>';
                photoPreview.className = 'photo-placeholder rounded-circle mx-auto d-flex align-items-center justify-content-center';
                photoPreview.style.cssText = 'width: 150px; height: 150px; background-color: #e9ecef; border: 3px dashed #dee2e6;';

                // Clear file input
                if (photoInput) {
                    photoInput.value = '';
                }
            }
        });
    }

    // Initialize character counters
    Object.keys(validationRules).forEach(fieldId => {
        const input = document.getElementById(fieldId);
        if (!input) return;

        const rules = validationRules[fieldId];
        const counter = input.parentNode.querySelector('.character-counter');
        
        if (!counter) return;

        function updateCounter() {
            const currentLength = input.value.length;
            const { min, max } = rules;

            counter.textContent = `${currentLength}/${max} (min: ${min})`;

            counter.classList.remove('warning', 'danger', 'success');
            if (currentLength < min) {
                counter.classList.add('danger');
            } else if (currentLength >= max - 10) {
                counter.classList.add('warning');
            } else {
                counter.classList.add('success');
            }
        }

        updateCounter();
        input.addEventListener('input', updateCounter);
        input.addEventListener('keyup', updateCounter);
    });

    // Letters-only validation for Name and Role
    const nameInput = document.getElementById('id_name');
    const roleInput = document.getElementById('id_role');

    if (nameInput) {
        nameInput.addEventListener('input', function(e) {
            // Allow only letters and spaces
            this.value = this.value.replace(/[^a-zA-Z\s]/g, '');
        });
    }

    if (roleInput) {
        roleInput.addEventListener('input', function(e) {
            // Allow only letters and spaces
            this.value = this.value.replace(/[^a-zA-Z\s]/g, '');
        });
    }

    // Form validation
    const form = document.getElementById('teamMemberForm');
    form.addEventListener('submit', function(e) {
        let hasErrors = false;
        const errors = [];

        // Check all inputs
        Object.keys(validationRules).forEach(fieldId => {
            const input = document.getElementById(fieldId);
            if (!input) return;

            const rules = validationRules[fieldId];
            const value = input.value.trim();
            const length = value.length;

            // Clear previous errors
            input.classList.remove('is-invalid');

            // Validate length
            if (length < rules.min) {
                hasErrors = true;
                input.classList.add('is-invalid');
                errors.push(`${rules.label} must be at least ${rules.min} characters`);
            } else if (length > rules.max) {
                hasErrors = true;
                input.classList.add('is-invalid');
                errors.push(`${rules.label} must not exceed ${rules.max} characters`);
            }

            // Letters-only validation
            if (rules.type === 'letters') {
                const lettersOnlyRegex = /^[a-zA-Z\s]+$/;
                if (!lettersOnlyRegex.test(value)) {
                    hasErrors = true;
                    input.classList.add('is-invalid');
                    errors.push(`${rules.label} must contain only letters and spaces`);
                }
            }

            // Check if empty (required fields)
            if (length === 0) {
                hasErrors = true;
                input.classList.add('is-invalid');
                errors.push(`${rules.label} is required`);
            }
        });

        if (hasErrors) {
            e.preventDefault();
            showAlert('Please fix the following errors:\n\n• ' + errors.join('\n• '), 'danger');

            // Scroll to first error
            const firstError = document.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 400px; white-space: pre-line;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(alertDiv);

        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 8000);
    }
});
</script>
{% endblock %}