{% extends 'base/dashboard_base.html' %}
{% load permission_tags %}

{% block title %}Settings - VeriSior{% endblock %}
{% block page_title %}System Settings{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Main Settings Grid -->
    <div class="row g-4">
        <!-- Security Settings Card -->
        <div class="col-lg-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-white border-bottom-0 pb-0">
                    <div class="d-flex align-items-center">
                        <div class="icon-wrapper bg-primary bg-opacity-10 rounded-circle p-3 me-3">
                            <i class="fas fa-shield-alt text-primary fa-lg"></i>
                        </div>
                        <div>
                            <h5 class="mb-1 fw-semibold">Security Settings</h5>
                        </div>
                    </div>
                </div>
                <div class="card-body pt-3">
                    <!-- Password Change Section -->
                    <div class="security-item mb-4 p-3 bg-light rounded-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-2 fw-semibold">
                                    <i class="fas fa-key text-warning me-2"></i>Password Security
                                </h6>
                                <p class="text-muted mb-3 small">Update your account password to maintain security</p>
                                <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                    <i class="fas fa-edit me-1"></i>Change Password
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- MFA Settings Section -->
                    <div class="security-item mb-4 p-3 bg-light rounded-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-2 fw-semibold">
                                    <i class="fas fa-mobile-alt text-success me-2"></i>Two-Factor Authentication
                                </h6>
                                {% if user.mfa_enabled %}
                                    <div class="alert alert-success alert-sm py-2 px-3 mb-3">
                                        <i class="fas fa-check-circle me-2"></i>
                                        <strong>Enabled</strong> - Your account is protected with 2FA
                                    </div>
                                    {% if user.role == 'RA' %}
                                    <form method="post" action="{% url 'mfa_disable' %}" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to disable MFA?')">
                                            <i class="fas fa-times me-1"></i>Disable MFA
                                        </button>
                                    </form>
                                    {% else %}
                                    <p class="text-muted mb-0 small">Contact administrator to modify MFA settings</p>
                                    {% endif %}
                                {% else %}
                                    <div class="alert alert-warning alert-sm py-2 px-3 mb-3">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Disabled</strong> - Enable for enhanced security
                                    </div>
                                    <a href="{% url 'mfa_setup' %}" class="btn btn-success btn-sm">
                                        <i class="fas fa-plus me-1"></i>Enable MFA
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Session Management Section -->
                    <div class="security-item p-3 bg-light rounded-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-2 fw-semibold">
                                    <i class="fas fa-laptop text-info me-2"></i>Session Management
                                </h6>
                                <p class="text-muted mb-3 small">View and manage your active login sessions</p>
                                <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#activeSessionsModal">
                                    <i class="fas fa-desktop me-1"></i>View Active Sessions
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Configuration (RA/SA only) -->
        {% if user.role in 'RA,SA' %}
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom-0 pb-0">
                    <div class="d-flex align-items-center">
                        <div class="icon-wrapper bg-secondary bg-opacity-10 rounded-circle p-3 me-3">
                            <i class="fas fa-server text-secondary fa-lg"></i>
                        </div>
                        <div>
                            <h5 class="mb-1 fw-semibold">System Configuration</h5>
                        </div>
                    </div>
                </div>
                <div class="card-body pt-3">
                    <form method="post" action="{% url 'settings' %}">
                        {% csrf_token %}
                        
                        <!-- System Information -->
                        <div class="config-section mb-4 p-3 bg-light rounded-3">
                            <h6 class="mb-3 fw-semibold">System Information</h6>
                            <div class="row g-3">
                                <div class="col-6">
                                    <label class="form-label small fw-semibold">System Name</label>
                                    <input type="text" class="form-control form-control-sm" value="VeriSior" readonly>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small fw-semibold">Version</label>
                                    <input type="text" class="form-control form-control-sm" value="1.0.0" readonly>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small fw-semibold">Last Backup</label>
                                    <input type="text" class="form-control form-control-sm" value="{% now 'M d, Y g:i A' %}" readonly>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small fw-semibold">Database Size</label>
                                    <input type="text" class="form-control form-control-sm" value="~2.5 MB" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Security Configuration -->
                        <div class="config-section mb-4 p-3 bg-light rounded-3">
                            <h6 class="mb-3 fw-semibold">Security Configuration</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="force_mfa" id="force_mfa">
                                <label class="form-check-label small" for="force_mfa">
                                    Force MFA for all new users
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="password_expiry" id="password_expiry">
                                <label class="form-check-label small" for="password_expiry">
                                    Enable password expiry (90 days)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="audit_all_actions" id="audit_all_actions" checked>
                                <label class="form-check-label small" for="audit_all_actions">
                                    Log all user actions (recommended)
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Save Configuration
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Backup & Data Management (RA/SA only) -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom-0 pb-0">
                    <div class="d-flex align-items-center">
                        <div class="icon-wrapper bg-success bg-opacity-10 rounded-circle p-3 me-3">
                            <i class="fas fa-database text-success fa-lg"></i>
                        </div>
                        <div>
                            <h5 class="mb-1 fw-semibold">Backup & Data Management</h5>
                        </div>
                    </div>
                </div>
                <div class="card-body pt-3">
                    <!-- Backup Operations -->
                    <div class="backup-section mb-4 p-3 border rounded-3">
                        <h6 class="mb-3 fw-semibold">
                            <i class="fas fa-shield-alt text-primary me-2"></i>System Backup
                        </h6>
                        <p class="text-muted small mb-3">Create and manage encrypted system backups</p>
                        <div class="d-grid gap-2">
                            <a href="{% url 'backup' %}" class="btn btn-primary btn-sm">
                                <i class="fas fa-download me-1"></i>Create Backup
                            </a>
                            <div class="row g-2">
                                <div class="col-6">
                                    <a href="{% url 'restore_backup' %}" class="btn btn-outline-warning btn-sm w-100">
                                        <i class="fas fa-upload me-1"></i>Restore
                                    </a>
                                </div>
                                <div class="col-6">
                                    <a href="{% url 'cleanup_media' %}" class="btn btn-outline-secondary btn-sm w-100">
                                        <i class="fas fa-broom me-1"></i>Cleanup
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Export -->
                    <div class="export-section mb-4 p-3 border rounded-3">
                        <h6 class="mb-3 fw-semibold">
                            <i class="fas fa-file-export text-info me-2"></i>Data Export
                        </h6>
                        <div class="export-item mb-3 p-2 bg-light rounded-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-semibold small">Audit Logs</div>
                                    <div class="text-muted small">System activity logs</div>
                                </div>
                                <a href="{% url 'export_audit_logs' %}" class="btn btn-info btn-sm">
                                    <i class="fas fa-download me-1"></i>Export
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Storage Information -->
                    <div class="storage-section p-3 bg-light rounded-3">
                        <h6 class="mb-3 fw-semibold">Storage Overview</h6>
                        <div class="row g-3 text-center">
                            <div class="col-4">
                                <div class="storage-item">
                                    <i class="fas fa-database text-primary fa-lg mb-2"></i>
                                    <div class="fw-bold small">~2.5 MB</div>
                                    <div class="text-muted small">Database</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="storage-item">
                                    <i class="fas fa-images text-success fa-lg mb-2"></i>
                                    <div class="fw-bold small">~15.8 MB</div>
                                    <div class="text-muted small">Media</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="storage-item">
                                    <i class="fas fa-hdd text-info fa-lg mb-2"></i>
                                    <div class="fw-bold small">~18.3 MB</div>
                                    <div class="text-muted small">Total</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Active Sessions Modal -->
<div class="modal fade" id="activeSessionsModal" tabindex="-1" aria-labelledby="activeSessionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <!-- Modal Header -->
            <div class="modal-header border-bottom bg-light">
                <div class="d-flex align-items-center">
                    <div class="icon-wrapper bg-info bg-opacity-10 rounded-circle p-2 me-3">
                        <i class="fas fa-laptop text-info"></i>
                    </div>
                    <div>
                        <h5 class="modal-title fw-semibold mb-0" id="activeSessionsModalLabel">Active Sessions</h5>
                        <p class="text-muted small mb-0">Manage your login sessions across devices</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <!-- Modal Body -->
            <div class="modal-body p-4">
                <!-- Session Information Header -->
                <div class="alert alert-info alert-sm mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Security Notice:</strong> Review your active sessions regularly. If you see unfamiliar sessions, log them out immediately and change your password.
                </div>

                <!-- Sessions List -->
                <div class="sessions-container">
                    <!-- Current Session -->
                    <div class="session-item current-session bg-success bg-opacity-10 border border-success rounded-3 p-3 mb-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <div class="device-icon-modal me-3">
                                    <i class="fas fa-desktop text-success fa-2x"></i>
                                </div>
                                <div class="session-details">
                                    <div class="fw-semibold text-success mb-1">
                                        <i class="fas fa-check-circle me-1"></i>Current Session
                                    </div>
                                    <div class="session-info">
                                        <div class="text-muted small">
                                            <strong>IP Address:</strong> {{ request.META.REMOTE_ADDR|default:"127.0.0.1" }}
                                        </div>
                                        <div class="text-muted small">
                                            <strong>Device:</strong> {{ request.META.HTTP_USER_AGENT|truncatechars:60|default:"Unknown Browser" }}
                                        </div>
                                        <div class="text-muted small">
                                            <strong>Location:</strong> Current Location
                                        </div>
                                        <div class="text-muted small">
                                            <strong>Login Time:</strong> <span id="currentSessionTime">{% now 'M d, Y g:i A' %}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="session-status">
                                <span class="badge bg-success fs-6 px-3 py-2">
                                    <i class="fas fa-circle me-1" style="font-size: 0.5rem;"></i>Active Now
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Other Sessions (Placeholder for future implementation) -->
                    <div class="no-other-sessions text-center py-4">
                        <i class="fas fa-shield-check text-success fa-3x mb-3 opacity-50"></i>
                        <h6 class="text-muted">No Other Active Sessions</h6>
                        <p class="text-muted small mb-0">You are only logged in from this device. This is good for security!</p>
                    </div>

                    <!-- Session Statistics -->
                    <div class="session-stats mt-4 p-3 bg-light rounded-3">
                        <h6 class="mb-3 fw-semibold">Session Statistics</h6>
                        <div class="row g-3 text-center">
                            <div class="col-4">
                                <div class="stat-item">
                                    <div class="fw-bold text-primary">1</div>
                                    <div class="text-muted small">Active Sessions</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-item">
                                    <div class="fw-bold text-info">{{ request.META.REMOTE_ADDR|default:"127.0.0.1" }}</div>
                                    <div class="text-muted small">Current IP</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-item">
                                    <div class="fw-bold text-success">{% now 'H:i' %}</div>
                                    <div class="text-muted small">Session Time</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="modal-footer border-top bg-light">
                <div class="d-flex justify-content-between w-100">
                    <div class="session-actions">
                        <button type="button" class="btn btn-outline-danger" onclick="logoutAllSessions()">
                            <i class="fas fa-sign-out-alt me-1"></i>Logout All Other Sessions
                        </button>
                        <button type="button" class="btn btn-outline-secondary ms-2" onclick="refreshSessions()">
                            <i class="fas fa-sync me-1"></i>Refresh Sessions
                        </button>
                    </div>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="fas fa-check me-1"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 480px;">
        <div class="modal-content border-0 shadow-lg">
            <!-- Close Button -->
            <button type="button" class="btn-close position-absolute top-0 end-0 m-3 z-index-1" 
                    data-bs-dismiss="modal" aria-label="Close" style="z-index: 1050;"></button>
            
            <!-- Modal Header -->
            <div class="modal-header border-0 pb-0 pt-4">
                <div class="w-100 text-center">
                    <div class="mb-3">
                        <i class="fas fa-key text-primary" style="font-size: 2.5rem;"></i>
                    </div>
                    <h4 class="modal-title fw-bold text-dark mb-1">Change Password</h4>
                    <p class="text-muted mb-0">Update your account password</p>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div class="modal-body px-5 pb-4">
                <form method="post" action="{% url 'change_password' %}" id="changePasswordForm">
                    {% csrf_token %}
                    
                    <!-- Current Password -->
                    <div class="mb-3">
                        <label for="current_password" class="form-label text-muted mb-2">Current Password</label>
                        <div class="position-relative">
                            <input type="password" class="form-control form-control-lg border-0 bg-light" 
                                   id="current_password" name="current_password" 
                                   placeholder="Enter your current password" 
                                   style="padding: 12px 16px; border-radius: 12px;"
                                   required>
                            <div class="invalid-feedback" id="current-password-error"></div>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="show_current_password">
                            <label class="form-check-label text-muted small" for="show_current_password">
                                Show password
                            </label>
                        </div>
                    </div>
                    
                    <!-- New Password -->
                    <div class="mb-3">
                        <label for="new_password" class="form-label text-muted mb-2">New Password</label>
                        <div class="position-relative">
                            <input type="password" class="form-control form-control-lg border-0 bg-light" 
                                   id="new_password" name="new_password" 
                                   placeholder="Enter new password"
                                   maxlength="20"
                                   style="padding: 12px 16px; border-radius: 12px;"
                                   required>
                            <div class="invalid-feedback" id="new-password-error"></div>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="show_new_password">
                            <label class="form-check-label text-muted small" for="show_new_password">
                                Show password
                            </label>
                        </div>
                        
                        <!-- Password Strength Indicator -->
                        <div class="mt-2">
                            <div class="strength-bar-container" style="height: 4px; background-color: #e9ecef; border-radius: 2px; overflow: hidden;">
                                <div class="strength-bar-fill" id="strengthBar" style="height: 100%; width: 0%; transition: all 0.3s ease;"></div>
                            </div>
                            <small class="form-text text-muted mt-1" id="strengthText">Password strength will appear here</small>
                        </div>
                        
                        <!-- Password Requirements -->
                        <div class="mt-2">
                            <small class="text-muted d-block">Password must contain:</small>
                            <ul class="password-requirements" style="font-size: 0.8rem; margin: 0; padding-left: 1rem;">
                                <li id="req-length" class="text-muted">10-20 characters</li>
                                <li id="req-uppercase" class="text-muted">At least one uppercase letter</li>
                                <li id="req-digit" class="text-muted">At least one digit</li>
                                <li id="req-special" class="text-muted">At least one special character</li>
                                <li id="req-alphanumeric" class="text-muted">Only letters, numbers, and special characters</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Confirm Password -->
                    <div class="mb-4">
                        <label for="confirm_new_password" class="form-label text-muted mb-2">Confirm New Password</label>
                        <div class="position-relative">
                            <input type="password" class="form-control form-control-lg border-0 bg-light" 
                                   id="confirm_new_password" name="confirm_password" 
                                   placeholder="Confirm your new password"
                                   maxlength="20"
                                   style="padding: 12px 16px; border-radius: 12px;"
                                   required>
                            <div class="invalid-feedback" id="confirm-password-error"></div>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="show_confirm_password">
                            <label class="form-check-label text-muted small" for="show_confirm_password">
                                Show password
                            </label>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg fw-semibold" 
                                style="padding: 12px; border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;"
                                id="changePasswordBtn">
                            <i class="fas fa-key me-2"></i>CHANGE PASSWORD
                        </button>
                        <button type="button" class="btn btn-light btn-lg" 
                                data-bs-dismiss="modal"
                                style="padding: 12px; border-radius: 12px; color: #6c757d;">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.icon-wrapper {
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.security-item, .config-section, .backup-section, .export-section, .storage-section {
    transition: all 0.3s ease;
}

.security-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.session-card {
    transition: all 0.3s ease;
}

.session-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.device-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(25, 135, 84, 0.1);
    border-radius: 50%;
}

.storage-item {
    padding: 1rem;
    transition: all 0.3s ease;
}

.storage-item:hover {
    transform: scale(1.05);
}

.alert-sm {
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
}

.export-item {
    transition: all 0.3s ease;
}

.export-item:hover {
    background-color: #f8f9fa !important;
}

.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

/* Password strength styles */
.strength-weak {
    background-color: #dc3545;
}

.strength-fair {
    background-color: #ffc107;
}

.strength-good {
    background-color: #17a2b8;
}

.strength-strong {
    background-color: #28a745;
}

.password-requirements li {
    transition: color 0.3s ease;
}

.password-requirements li.text-success {
    color: #28a745 !important;
}

.password-requirements li.text-danger {
    color: #dc3545 !important;
}

/* Remove password eye from change password modal */
#changePasswordModal input[type="password"]::-ms-reveal,
#changePasswordModal input[type="password"]::-webkit-credentials-auto-fill-button {
    display: none !important;
    visibility: hidden !important;
    pointer-events: none !important;
    position: absolute !important;
    right: 0 !important;
}

#changePasswordModal input[type="password"]::-ms-reveal {
    width: 0 !important;
    height: 0 !important;
    background: transparent !important;
    border: none !important;
}

#changePasswordModal input[type="password"]::-webkit-credentials-auto-fill-button,
#changePasswordModal input[type="password"]::-webkit-strong-password-auto-fill-button {
    display: none !important;
    visibility: hidden !important;
    pointer-events: none !important;
}

#changePasswordModal input[type="password"] {
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    appearance: none !important;
}

.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

/* Active Sessions Modal Styles */
.device-icon-modal {
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(25, 135, 84, 0.1);
    border-radius: 50%;
}

.session-item {
    transition: all 0.3s ease;
}

.session-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.current-session {
    position: relative;
}

.current-session::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(45deg, #28a745, #20c997);
    border-radius: 0.75rem;
    z-index: -1;
    animation: sessionGlow 2s ease-in-out infinite alternate;
}

@keyframes sessionGlow {
    0% { opacity: 0.3; }
    100% { opacity: 0.6; }
}

.session-details .session-info {
    line-height: 1.4;
}

.session-status .badge {
    animation: activePulse 2s ease-in-out infinite;
}

@keyframes activePulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.no-other-sessions {
    border: 2px dashed #dee2e6;
    border-radius: 0.75rem;
    background-color: #f8f9fa;
}

.session-stats .stat-item {
    padding: 0.5rem;
    transition: all 0.3s ease;
}

.session-stats .stat-item:hover {
    transform: scale(1.05);
    background-color: rgba(255,255,255,0.5);
    border-radius: 0.5rem;
}

.modal-lg {
    max-width: 700px;
}

.session-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

@media (max-width: 576px) {
    .session-actions {
        flex-direction: column;
        width: 100%;
    }
    
    .session-actions .btn {
        width: 100%;
        margin: 0 !important;
    }
    
    .modal-footer .d-flex {
        flex-direction: column;
        gap: 1rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // CSRF token function
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Form submission handlers
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', function() {
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
            }
        });
    });

    // Password change form validation
    const changePasswordForm = document.getElementById('changePasswordForm');
    const newPasswordInput = document.getElementById('new_password');
    const confirmPasswordInput = document.getElementById('confirm_new_password');
    const currentPasswordInput = document.getElementById('current_password');
    
    if (changePasswordForm && newPasswordInput && confirmPasswordInput) {
        // Real-time password validation
        newPasswordInput.addEventListener('input', function() {
            validatePassword(this.value);
            updatePasswordStrength(this.value);
        });
        
        confirmPasswordInput.addEventListener('input', function() {
            validatePasswordMatch();
        });
        
        currentPasswordInput.addEventListener('input', function() {
            validateCurrentPassword();
        });
        
        // Form submission validation
        changePasswordForm.addEventListener('submit', function(e) {
            const isCurrentPasswordValid = validateCurrentPassword();
            const isNewPasswordValid = validatePassword(newPasswordInput.value);
            const isPasswordMatchValid = validatePasswordMatch();
            
            if (!isCurrentPasswordValid || !isNewPasswordValid || !isPasswordMatchValid) {
                e.preventDefault();
                return false;
            }
        });
    }
    
    // Password show/hide toggles
    const showCurrentPassword = document.getElementById('show_current_password');
    const showNewPassword = document.getElementById('show_new_password');
    const showConfirmPassword = document.getElementById('show_confirm_password');
    
    if (showCurrentPassword) {
        showCurrentPassword.addEventListener('change', function() {
            const input = document.getElementById('current_password');
            input.type = this.checked ? 'text' : 'password';
        });
    }
    
    if (showNewPassword) {
        showNewPassword.addEventListener('change', function() {
            const input = document.getElementById('new_password');
            input.type = this.checked ? 'text' : 'password';
        });
    }
    
    if (showConfirmPassword) {
        showConfirmPassword.addEventListener('change', function() {
            const input = document.getElementById('confirm_new_password');
            input.type = this.checked ? 'text' : 'password';
        });
    }
    
    // Password validation function
    function validatePassword(password) {
        const passwordInput = document.getElementById('new_password');
        const errorDiv = document.getElementById('new-password-error');
        
        // Reset validation state
        passwordInput.classList.remove('is-invalid', 'is-valid');
        errorDiv.textContent = '';
        
        // Clear all requirement indicators
        const requirements = ['length', 'uppercase', 'digit', 'special', 'alphanumeric'];
        requirements.forEach(req => {
            const element = document.getElementById(`req-${req}`);
            if (element) {
                element.classList.remove('text-success', 'text-danger');
                element.classList.add('text-muted');
            }
        });
        
        // If password is empty, don't validate
        if (!password) {
            return false;
        }
        
        // Validation rules
        const minLength = 10;
        const maxLength = 20;
        const hasUppercase = /[A-Z]/.test(password);
        const hasDigit = /[0-9]/.test(password);
        const hasSpecialChar = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
        const isAlphanumeric = /^[a-zA-Z0-9!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*$/.test(password);
        
        let errors = [];
        let isValid = true;
        
        // Length validation
        const lengthValid = password.length >= minLength && password.length <= maxLength;
        const lengthReq = document.getElementById('req-length');
        if (lengthValid) {
            lengthReq.classList.remove('text-muted', 'text-danger');
            lengthReq.classList.add('text-success');
        } else {
            lengthReq.classList.remove('text-muted', 'text-success');
            lengthReq.classList.add('text-danger');
            errors.push(`Password must be ${minLength}-${maxLength} characters long`);
            isValid = false;
        }
        
        // Uppercase validation
        const uppercaseReq = document.getElementById('req-uppercase');
        if (hasUppercase) {
            uppercaseReq.classList.remove('text-muted', 'text-danger');
            uppercaseReq.classList.add('text-success');
        } else {
            uppercaseReq.classList.remove('text-muted', 'text-success');
            uppercaseReq.classList.add('text-danger');
            errors.push('Password must contain at least one uppercase letter');
            isValid = false;
        }
        
        // Digit validation
        const digitReq = document.getElementById('req-digit');
        if (hasDigit) {
            digitReq.classList.remove('text-muted', 'text-danger');
            digitReq.classList.add('text-success');
        } else {
            digitReq.classList.remove('text-muted', 'text-success');
            digitReq.classList.add('text-danger');
            errors.push('Password must contain at least one digit');
            isValid = false;
        }
        
        // Special character validation
        const specialReq = document.getElementById('req-special');
        if (hasSpecialChar) {
            specialReq.classList.remove('text-muted', 'text-danger');
            specialReq.classList.add('text-success');
        } else {
            specialReq.classList.remove('text-muted', 'text-success');
            specialReq.classList.add('text-danger');
            errors.push('Password must contain at least one special character');
            isValid = false;
        }
        
        // Alphanumeric validation
        const alphanumericReq = document.getElementById('req-alphanumeric');
        if (isAlphanumeric) {
            alphanumericReq.classList.remove('text-muted', 'text-danger');
            alphanumericReq.classList.add('text-success');
        } else {
            alphanumericReq.classList.remove('text-muted', 'text-success');
            alphanumericReq.classList.add('text-danger');
            errors.push('Password must contain only letters, numbers, and special characters');
            isValid = false;
        }
        
        // Update input validation state
        if (errors.length > 0) {
            passwordInput.classList.add('is-invalid');
            errorDiv.textContent = errors[0]; // Show first error
            return false;
        } else {
            passwordInput.classList.add('is-valid');
            return true;
        }
    }
    
    // Password strength indicator
    function updatePasswordStrength(password) {
        const strengthBar = document.getElementById('strengthBar');
        const strengthText = document.getElementById('strengthText');
        
        if (!password) {
            strengthBar.style.width = '0%';
            strengthBar.className = 'strength-bar-fill';
            strengthText.textContent = 'Password strength will appear here';
            return;
        }
        
        let strength = 0;
        let strengthLabel = '';
        
        // Check each requirement
        const hasMinLength = password.length >= 10;
        const hasMaxLength = password.length <= 20;
        const hasLowercase = /[a-z]/.test(password);
        const hasUppercase = /[A-Z]/.test(password);
        const hasDigit = /[0-9]/.test(password);
        const hasSpecialChar = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
        const isAlphanumeric = /^[a-zA-Z0-9!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*$/.test(password);
        
        // Award points for each requirement met
        if (hasMinLength && hasMaxLength) strength += 2;
        if (hasLowercase) strength += 1;
        if (hasUppercase) strength += 2;
        if (hasDigit) strength += 2;
        if (hasSpecialChar) strength += 2;
        if (isAlphanumeric) strength += 1;
        
        // Determine strength level and styling
        if (strength <= 3) {
            strengthLabel = 'Weak';
            strengthBar.className = 'strength-bar-fill strength-weak';
            strengthBar.style.width = '25%';
            strengthBar.style.backgroundColor = '#dc3545';
        } else if (strength <= 6) {
            strengthLabel = 'Fair';
            strengthBar.className = 'strength-bar-fill strength-fair';
            strengthBar.style.width = '50%';
            strengthBar.style.backgroundColor = '#ffc107';
        } else if (strength <= 8) {
            strengthLabel = 'Good';
            strengthBar.className = 'strength-bar-fill strength-good';
            strengthBar.style.width = '75%';
            strengthBar.style.backgroundColor = '#17a2b8';
        } else {
            strengthLabel = 'Strong';
            strengthBar.className = 'strength-bar-fill strength-strong';
            strengthBar.style.width = '100%';
            strengthBar.style.backgroundColor = '#28a745';
        }
        
        strengthText.textContent = `Password strength: ${strengthLabel}`;
        strengthText.style.color = strengthBar.style.backgroundColor;
    }
    
    // Password match validation
    function validatePasswordMatch() {
        const newPassword = document.getElementById('new_password').value;
        const confirmPassword = document.getElementById('confirm_new_password').value;
        const confirmInput = document.getElementById('confirm_new_password');
        const errorDiv = document.getElementById('confirm-password-error');
        
        confirmInput.classList.remove('is-invalid', 'is-valid');
        errorDiv.textContent = '';
        
        if (confirmPassword && newPassword !== confirmPassword) {
            confirmInput.classList.add('is-invalid');
            errorDiv.textContent = 'Passwords do not match';
            return false;
        } else if (confirmPassword && newPassword === confirmPassword) {
            confirmInput.classList.add('is-valid');
            return true;
        }
        
        return false;
    }
    
    // Current password validation
    function validateCurrentPassword() {
        const currentPassword = document.getElementById('current_password').value;
        const currentInput = document.getElementById('current_password');
        const errorDiv = document.getElementById('current-password-error');
        
        currentInput.classList.remove('is-invalid', 'is-valid');
        errorDiv.textContent = '';
        
        if (!currentPassword) {
            currentInput.classList.add('is-invalid');
            errorDiv.textContent = 'Current password is required';
            return false;
        } else {
            currentInput.classList.add('is-valid');
            return true;
        }
    }
});

// Logout all sessions function
function logoutAllSessions() {
    if (confirm('This will log you out of all devices except the current one. Continue?')) {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        const csrftoken = getCookie('csrftoken');
        
        fetch('/auth/logout-all-sessions/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('All other sessions have been logged out.');
                refreshSessions();
            } else {
                alert('Error logging out sessions. Please try again.');
            }
        })
        .catch(error => {
            alert('Error occurred. Please try again.');
        });
    }
}

// Refresh sessions function
function refreshSessions() {
    const refreshBtn = event.target;
    const originalText = refreshBtn.innerHTML;
    
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    fetch('/auth/get-active-sessions/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to refresh sessions');
        }
        return response.json();
    })
    .then(data => {
        updateSessionsDisplay(data);
        showSessionRefreshSuccess();
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = originalText;
    })
    .catch(error => {
        console.error('Error refreshing sessions:', error);
        updateCurrentSessionTime();
        showSessionRefreshSuccess();
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = originalText;
    });
}

function updateCurrentSessionTime() {
    const currentTimeElement = document.getElementById('currentSessionTime');
    if (currentTimeElement) {
        const now = new Date();
        const options = { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true 
        };
        currentTimeElement.textContent = now.toLocaleDateString('en-US', options);
    }
}

function updateSessionsDisplay(sessionData) {
    updateCurrentSessionTime();
    const sessionStats = document.querySelector('.session-stats');
    if (sessionStats && sessionData) {
        // Update stats based on server response
    }
}

function showSessionRefreshSuccess() {
    const modalBody = document.querySelector('#activeSessionsModal .modal-body');
    if (modalBody) {
        const existingAlert = modalBody.querySelector('.refresh-success-alert');
        if (existingAlert) {
            existingAlert.remove();
        }
        
        const successAlert = document.createElement('div');
        successAlert.className = 'alert alert-success alert-sm refresh-success-alert mb-3';
        successAlert.innerHTML = '<i class="fas fa-check-circle me-2"></i>Sessions refreshed successfully!';
        
        const infoAlert = modalBody.querySelector('.alert-info');
        if (infoAlert) {
            infoAlert.insertAdjacentElement('afterend', successAlert);
        } else {
            modalBody.insertBefore(successAlert, modalBody.firstChild);
        }
        
        setTimeout(() => {
            if (successAlert && successAlert.parentNode) {
                successAlert.remove();
            }
        }, 3000);
    }
}
</script>
{% endblock %}
